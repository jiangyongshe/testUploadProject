var pageNo=1,count=8,playIdle="",orderStatus="",adName="";

$(function(){
	$("#headerTitle").text("广告订单");
	$(".filterHeader").hide();
	initMescroll();//初始化下拉控件
	appendDetailDiv();//详情弹出框
})

/*上拉加载的回调 page = {num:1, size:10}; num:当前页 从1开始, size:每页数据条数 */
function upCallback(page){
	//联网加载数据
	console.log("page.num="+page.num);
	loadOrderInfo({
		pageNo:page.num,
		pageSize:count,
		playIdle:playIdle,
		orderStatus:orderStatus,
		adName:adName
	});
}
//加载用户订单
function loadOrderInfo(obj){
	jsonAjax("/"+language+"/order/queryOrder.do",obj,function(res){
		//联网成功的回调,隐藏上拉加载的状态
		if(res.data==null||res.data==[]){
			mescroll.endSuccess(0);
			return;
		}
		mescroll.endSuccess(res.data.list.length);//传参:数据的总数; mescroll会自动判断列表如果无任何数据,则提示空;列表无下一页数据,则提示无更多数据;
		if(res.data.list.length>0){
			var data=res.data,date=new Date().format(DATE_FORMAT_YTD);
			var listDom=document.getElementById("dataList");
			for (var i = 0; i < data.list.length; i++) {
				var dto=data.list[i],statusText="",cssClass="",imgs="",disable="",cancelReason="",str="";
				if(dto.order_status==1){
					disable="gray";
					statusText="待付款";
					cssClass="withoutPayment";
				}else if(dto.order_status<4){
					statusText="处理中";
					cssClass="application";
				}else if(dto.order_status==4&&dto.order_type!=4){
					if(date<dto.startDate){
						statusText="待发布";
						cssClass="watingPlay";
					}else if(dto.startDate<=date&&date<=dto.endDate){
						statusText="播放中";
						cssClass="playing";
					}else if(date>dto.endDate){
						statusText="已取消";
						cssClass="closed";
					}
				}else if(dto.order_type==4&&dto.order_status==4){
					statusText="已取消";
					cssClass="played";
				}else{
					if(dto.order_status==5){
						statusText="已取消";
						cssClass="auditNotPass";
					}else if(dto.order_status==6||dto.order_status==8){
						statusText="已取消";
						disable="gray";
						cssClass="canceled";
					}else if(dto.order_status==7){
						statusText="已取消";
						cssClass="closed";
					}
				}
				var fileType="视频",deleteStr='';//上传文件类型
				if(dto.file_type=="2"){
					fileType="图文模板";
				}else if(dto.file_type=="3"){
					fileType="图片";
				}
				if(dto.pics!=null&&dto.pics!=""){
					imgs=dto.pics.split(",");
				}
				/*if(addr!=null&&addr!=""){,addr=dto.mailing_address
					var addrList=dto.mailing_address.split("*");
					if(addrList[0]==addrList[1]){
						addr=dto.mailing_address.replace(addrList[0],"");
					}
				}*/
				if(dto.order_status==1||dto.order_status>4){
					deleteStr='<span class="wddd-more pad-r10 col-999">更多<span class="pos-a wddd-shan" onclick="deleteOrderByOrderNo({orderNo:'+(dto.if_sub==2?dto.unified_serial_number:dto.serial_number)+'})">删除订单</span></span>';
				}
				if(dto.if_sub==2){
					if($("#"+dto.unified_serial_number).length==0){
						str='<div class="ggdd-tit bor-b pad-b5 font13" id="'+dto.unified_serial_number+'">';
						str+='<span><i class="fa fa-angle-right pad-r5" aria-hidden="true"></i>订单编号：'+dto.unified_serial_number+'</span>';
						str+='<div class="fr pos-r">';
						str+=deleteStr;
						str+='<b class="red">'+statusText+'</b>';
						str+='</div>';
						str+='</div>';
						str+='<div class="ggdp-ny bor-b2 pos-r">';
						str+='<div class="ggdp-list1-tp pos-a" onclick="showShopDetail(\''+dto.shop_name+'\',\''+dto.mailing_address+'\',\''+dto.pics+'\')">';
						str+='<span><img src="'+(imgs==""?'/chinese/mobile/images/zwtp.png':imagePath+imgs[0])+'" /></span>';
						str+='</div>';
						str+='<div class="ggdp-list1-nr pos-r">';
						str+='<p class="">广告屏编号：<span class="">'+dto.device_code+'</span></p>';
						str+='<p class="">店铺：<span class="">'+dto.shop_name+'</span></p>';
						str+='<div class="pos-r pltf-dz">';
						str+='<span class="">'+dto.mailing_address.replace(/\*/g,"").replace(/&/g,"")+'</span>';
						str+='<a href="#" onclick="elementDisplay(\'tc-map\')" class="pos-a pltf-dz2"><i class="fa fa-map-marker red" aria-hidden="true"></i></a>';
						str+='</div>';
						str+='</div>';
						str+='</div>';
						str+='<div class="clear fl width100 pad-t10 pad-b10 pos-r">';
						str+='<p class="fl width56"><span class="dis-in ggdd-btl">投放类型</span><span class="dis-in ggdd-btr">'+fileType+'</span></p>';
						str+='<p class="fr width42"><span class="dis-in">单价</span><span class="dis-in fr text-r">'+dto.ad_price+'元/天</span></p>';
						str+='<p class="fl width56"><span class="dis-in ggdd-btl">屏数</span><span class="dis-in ggdd-btr"><span class="buyCount">1</span>台</span></p>';
						str+='<p class="fr width42"><span class="dis-in">投放天数</span><span class="dis-in fr text-r">'+dto.days+'天</span></p>';
						str+='<p class="fl width56 content*">';
						str+='<span class="dis-in ggdd-btl">投放内容</span>';
						if(dto.order_status>=4){
							if(dto.order_status==5){
								str+='<a href="shangchuanshipin.html?type=u&adNo='+dto.unified_serial_number+'&fileType='+dto.file_type+'" class="red pad-l5 pad-r5"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 修改</a>';
							}else if(dto.order_status==6){
								str=str.replace("content*","hide");
							}else if(dto.order_status==8){
								str=str.replace("content*","hide");
							}else{
								str+='<a href="chakanshipin.html?type=q&adNo='+dto.unified_serial_number+'" class="red pad-l5"><i class="fa fa-building-o" aria-hidden="true"></i> 查看</a>';
							}
							
						}else{
							if(dto.order_status==2){
								str+='<a href="shangchuanshipin.html?adNo='+dto.unified_serial_number+'&isInterCut=2&fileType='+dto.file_type+'" class="red pad-l5"><i class="fa fa-upload" aria-hidden="true"></i> 上传</a>';
							}else if(dto.order_status==3){
								str+='<a href="shangchuanshipin.html?type=u&adNo='+dto.unified_serial_number+'&fileType='+dto.file_type+'" class="red pad-l5"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 修改</a>';
								str+='<a href="chakanshipin.html?type=q&adNo='+dto.unified_serial_number+'" class="red pad-l10"><i class="fa fa-building-o" aria-hidden="true"></i> 查看</a>';
							}
						}
						str+='</p>';
						str+='<p class="fr width42 red"><span class="dis-in">总额</span><span class="dis-in fr font16 text-r">¥ <span class="sumPrice">'+dto.sumPrice+'</span></span></p>';
						str+='</div>';
						if(dto.order_status==5){
							str+='<p class="clear red pad-t5 bor-t3">取消原因：<span class="col-666">'+dto.result+'</span></p>';
						}
					}else{
						str='<div class="ggdp-ny bor-b2 pos-r">';
						str+='<div class="ggdp-list1-tp pos-a" onclick="showShopDetail(\''+dto.shop_name+'\',\''+dto.mailing_address+'\',\''+dto.pics+'\')">';
						str+='<span><img src="'+(imgs==""?'/chinese/mobile/images/zwtp.png':imagePath+imgs[0])+'" /></span>';
						str+='</div>';
						str+='<div class="ggdp-list1-nr pos-r">';
						str+='<p class="">广告屏编号：<span class="">'+dto.device_code+'</span></p>';
						str+='<p class="">店铺：<span class="">'+dto.shop_name+'</span></p>';
						str+='<div class="pos-r pltf-dz">';
						str+='<span class="">'+dto.mailing_address.replace(/\*/g,"").replace(/&/g,"")+'</span>';
						str+='<a href="#" onclick="elementDisplay(\'tc-map\')" class="pos-a pltf-dz2"><i class="fa fa-map-marker red" aria-hidden="true"></i></a>';
						str+='</div>';
						str+='</div>';
						str+='</div>';
						$("#"+dto.unified_serial_number).after(str);
						var sumPrice =$("#"+dto.unified_serial_number).parent().find(".sumPrice");//费用总计
						var buyCount=$("#"+dto.unified_serial_number).parent().find(".buyCount");
						if(dto.order_status==1){
							var payHref =$("#"+dto.unified_serial_number).parent().find(".payHref");//支付路径
							payHref.attr("href",payHref.attr("href").replace("&sumPrice="+sumPrice.text(),"&sumPrice="+(parseFloat(sumPrice.text())+parseFloat(dto.sumPrice))));
						}
						sumPrice.text(parseFloat(sumPrice.text())+parseFloat(dto.sumPrice));
						buyCount.text(parseInt(buyCount.text())+1);
						continue;
					}
				}else{
					str='<div class="ggdd-tit bor-b pad-b5 font13">';
					str+='<span><i class="fa fa-angle-right pad-r5" aria-hidden="true"></i>订单编号：'+dto.serial_number+'</span>';
					str+='<div class="fr pos-r">';
					str+=deleteStr;
					str+='<b class="red">'+statusText+'</b>';
					str+='</div>';
					str+='</div>';
					str+='<div class="ggdp-ny bor-b2 pos-r">';
					str+='<div class="ggdp-list1-tp pos-a" onclick="showShopDetail(\''+dto.shop_name+'\',\''+dto.mailing_address+'\',\''+dto.pics+'\')">';
					str+='<span><img src="'+(imgs==""?'/chinese/mobile/images/zwtp.png':imagePath+imgs[0])+'" /></span>';
					str+='</div>';
					str+='<div class="ggdp-list1-nr pos-r">';
					str+='<p class="">广告屏编号：<span class="">'+dto.device_code+'</span></p>';
					str+='<p class="">店铺：<span class="">'+dto.shop_name+'</span></p>';
					str+='<div class="pos-r pltf-dz">';
					str+='<span class="">'+dto.mailing_address.replace(/\*/g,"").replace(/&/g,"")+'</span>';
					str+='<a href="#" onclick="elementDisplay(\'tc-map\')" class="pos-a pltf-dz2"><i class="fa fa-map-marker red" aria-hidden="true"></i></a>';
					str+='</div>';
					str+='</div>';
					str+='</div>';
					str+='<div class="clear fl width100 pad-t10 pad-b10 pos-r">';
					str+='<p class="fl width56"><span class="dis-in ggdd-btl">投放类型</span><span class="dis-in ggdd-btr">'+fileType+'</span></p>';
					str+='<p class="fr width42"><span class="dis-in">单价</span><span class="dis-in fr text-r">'+dto.ad_price+'元/天</span></p>';
					str+='<p class="fl width56"><span class="dis-in ggdd-btl">屏数</span><span class="dis-in ggdd-btr">1台</span></p>';
					str+='<p class="fr width42"><span class="dis-in">投放天数</span><span class="dis-in fr text-r">'+dto.days+'天</span></p>';

					str+='<p class="fl width56 content*">';
					str+='<span class="dis-in ggdd-btl">投放内容</span>';
					
					if(dto.order_status>=4){
						if(dto.order_status==5){
							str+='<a href="shangchuanshipin.html?type=u&adNo='+dto.serial_number+'&fileType='+dto.file_type+'" class="red pad-l5 pad-r5"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 修改</a>';
						}else if(dto.order_status==6){
							str=str.replace("content*","hide");
						}else if(dto.order_status==8){
							str=str.replace("content*","hide");
						}else{
							str+='<a href="chakanshipin.html?type=q&adNo='+dto.serial_number+'" class="red pad-r10"><i class="fa fa-building-o" aria-hidden="true"></i> 查看</a>';
						}
					}else{
						if(dto.order_status==2){
							str+='<a href="shangchuanshipin.html?adNo='+dto.serial_number+'&isInterCut=2&fileType='+dto.file_type+'" class="red pad-r10"><i class="fa fa-upload" aria-hidden="true"></i> 上传</a>';
						}else if(dto.order_status==3){
							str+='<a href="shangchuanshipin.html?type=u&adNo='+dto.serial_number+'&fileType='+dto.file_type+'" class="red pad-r10"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 修改</a>';
							str+='<a href="chakanshipin.html?type=q&adNo='+dto.serial_number+'" class="red pad-r10"><i class="fa fa-building-o" aria-hidden="true"></i> 查看</a>';
						}
					}
					str+='</p>';
					str+='<p class="fr width42 red"><span class="dis-in">总额</span><span class="dis-in fr font16 text-r">¥ <span class="sumPrice">'+dto.sumPrice+'</span></span></p>';
					str+='</div>';
					
					
				}
				if(dto.order_status==5){
					str+='<p class="clear red pad-t5 bor-t3">取消原因：<span class="col-666">'+dto.result+'</span></p>';
				}
				if(dto.order_status==1){
					str+='<div class="ggdd-an bor-t2 text-r clear">';
				    str+='<span class="btn btn03 bor-rad bg-yellow" onclick="javascript:window.location.href=\'tfgg01.html?orderNo='+dto.serial_number+'&pay=1'+(dto.order_type==2?'&isInterCut=2':'\'')+'">去支付</span>';
				    str+='</div>';
				}
				var liDom=document.createElement("li");
				liDom.setAttribute('class','dingdan '+cssClass);
				liDom.innerHTML=str;
				listDom.appendChild(liDom);//加在列表的后面,上拉加载
			}
			changeStatus($("ul .active").attr("id"),$("ul .active")[0]);
		}else{
			if(obj.pageNo==1){
				showEmplyDiv("无订单记录,<a href='tfgg.html' class='red'>去下单</a>","#dataList");
			}
		}
	},function(){},"get");
}
var orderNo="";
function queryEffectualTimeByOrderNo(obj){
	if(orderNo==""){
		initQueryDate();//第一次弹出初始化日期控件
	}
	if(obj.orderNo!=null&&obj.orderNo!=undefined&&obj.orderNo!=""){
		orderNo=obj.orderNo;
	}else{
		obj.orderNo=orderNo;
	}
	jsonAjax("/"+language+"/order/queryEffectualTimeByOrderNo.do",obj,function(res){
		if(res.data!=null&&res.data!=[]){
			var html="",data=res.data,date=new Date().format(DATE_FORMAT_YTD);
			html+='<tr>';
			html+='  <th>时间</th>';
			html+='  <th>状态</th>';
			html+='</tr>';
			for (var i = 0; i < data.length; i++) {
				var status="未播放",cl="red";
				if(new Date(data[i].play_date.replace(/-/g, "/"))<new Date(date.replace(/-/g, "/"))){
					status="已播放",cl="green";
				}else if(data[i].play_date==date){
					status="正在播放",cl="col-999";
				}
				html+='<tr>';
				html+='  <td>'+data[i].play_date+'</td>';
				html+='  <td><span class="'+cl+'">'+status+'</span></td>';
				html+='</tr>';
			}
			$("#timeTable").html("");
			$("#timeTable").html(html);
			$("#shiduandiv").show();
		}
	},function(){},"get");
}
//有效时段搜索按钮
function seachEffectualTimeBtn(){
	var beginTime=$("#user_age1").val();
	var endTime=$("#user_age2").val();
	
	queryEffectualTimeByOrderNo({beginTime:beginTime,endTime:endTime});
	
}
//清空时间
function clearDate(){
	$(".beginTime").val("");
	$(".endTime").val("");
}


//根据不同订单状态显示
function changeStatus(id,obj){
	$(".dingdan").hide();
	if(id==""||id==null||id==undefined){
		$(".dingdan").show();
	}else{
		$("."+id).show();
	}
	$(obj).parent().find("li").removeClass("active");
	$(obj).addClass("active");
}
//删除订单
function deleteOrderByOrderNo(obj){
	jsonAjax("/"+language+"/order/deleteOrder.do",obj,function(res){
		if(res.succuess){
			showJudegTip("success",res.data);
		}else{
			showJudegTip("fail",res.data);
		}
	},function(){},"get");
}

